steps:
  # backend to app engine
  - name: gcr.io/cloud-builders/gcloud
    dir: "backend"
    entrypoint: "bash"
    args:
      - -c
      - echo "JWT_SECRET_KEY=$(gcloud secrets versions access latest --secret=jwt-secret-key --format='get(payload.data)' | tr '_-' '/+' | base64 -d)" > .env.local
      - echo "AUTH2_CLIENT_ID=$(gcloud secrets versions access latest --secret=google-oauth2-client-id --format='get(payload.data)' | tr '_-' '/+' | base64 -d)" > .env.local
      - echo "CLIENT_SECRET=$(gcloud secrets versions access latest --secret=google-oauth2-client-secret --format='get(payload.data)' | tr '_-' '/+' | base64 -d)" > .env.local
      - echo "GMAIL_PASSWORD=$(gcloud secrets versions access latest --secret=gmail-password --format='get(payload.data)' | tr '_-' '/+' | base64 -d)" > .env.local
      - echo "FIREBASE_SERVICE_ACCOUNT_PRIVATE_KEY=$(gcloud secrets versions access latest --secret=firebase-service-account-private-key --format='get(payload.data)' | tr '_-' '/+' | base64 -d)" > .env.local

  - name: "gcr.io/cloud-builders/gcloud"
    dir: "backend"
    args: ["app", "deploy"]

  ## frontend
  # - name: gcr.io/cloud-builders/npm
  #   args: [install]
  #   dir: "frontend"
  # - name: gcr.io/cloud-builders/npm
  #   dir: "frontend"
  #   args: ["run", "create-env"]
  #   env:
  #     - "REACT_APP_BACKEND_URL=${_REACT_APP_BACKEND_URL}"
  # - name: gcr.io/cloud-builders/npm
  #   args: [run, build]
  #   dir: "frontend"
  # # Deploy
  # - name: "gcr.io/cloud-builders/gcloud"
  #   dir: "frontend"
  #   entrypoint: bash
  #   args:
  #     - "-c"
  #     - |
  #       cp app.yaml ./build
  #       cd build
  #       gcloud app deploy
# images:
#   [
#     "gcr.io/theodercafe/backend:$BRANCH_NAME-$COMMIT_SHA",
#     "gcr.io/theodercafe/backend:latest",
#   ]

timeout: "1200s"
